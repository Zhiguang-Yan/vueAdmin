<template>
  <el-card
    class="box-card"
    v-loading.fullscreen.lock="fullscreenLoading"
    element-loading-text="Ê≠£Âú®Âä†ËΩΩ‰∏≠"
    element-loading-background="rgba(0, 0, 0, 0.8)"
  >
    <breadcrumb :level1="level1" :level2="level2"></breadcrumb>
    <el-row :gutter="10" class="select">
      <el-col :span="8">
        <el-input placeholder="ËØ∑ËæìÂÖ•ÂÜÖÂÆπ" v-model="query" :clearable="true">
          <el-button slot="append" icon="el-icon-search" @click="searchUsers"></el-button>
        </el-input>
      </el-col>
      <el-col :span="8">
        <el-button type="success" @click="dialogFormVisibleAdd = true">Ê∑ªÂä†Áî®Êà∑</el-button>
      </el-col>
    </el-row>

    <!-- Ë°®Ê†º -->
    <el-table height="350px" :data="userList" style="width: 100%" :border="true">
      <el-table-column label="#" width="40" type="index"></el-table-column>
      <el-table-column prop="username" label="ÂßìÂêç" width="120"></el-table-column>
      <el-table-column prop="email" label="ÈÇÆÁÆ±" width="200"></el-table-column>
      <el-table-column prop="mobile" label="ÁîµËØù" width="120"></el-table-column>
      <el-table-column label="ÂàõÂª∫Êó∂Èó¥" width="120">
        <template slot-scope="scope">{{scope.row.create_time | fmtdate}}</template>
      </el-table-column>
      <el-table-column label="Áî®Êà∑Áä∂ÊÄÅ" width="120">
        <template slot-scope="scope">
          <el-tooltip content="ÊÇ®Á°ÆÂÆöË¶ÅÊîπÂèòÁä∂ÊÄÅ(„ÄÇ„Éª‚àÄ„Éª)„Éé" placement="top" effect="light">
            <el-switch
              @change="changMsgState(scope.row)"
              inactive-text="üò°"
              active-text="üòä"
              v-model="scope.row.mg_state"
              active-color="#13ce66"
              inactive-color="#ff4949"
            ></el-switch>
          </el-tooltip>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="Êìç‰Ωú">
        <template slot-scope="scope">
          <el-button
            type="primary"
            plain
            icon="el-icon-edit"
            @click="showEditUserDia(scope.row)"
            size="medium"
            circle
          ></el-button>
          <el-button
            @click="showDeleUserMsgBox(scope.row.id)"
            type="danger"
            plain
            icon="el-icon-delete"
            size="medium"
            circle
          ></el-button>
          <el-button
            @click="showSetUserRoleDrawer(scope.row)"
            type="success"
            plain
            icon="el-icon-check"
            size="medium"
            circle
          ></el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- Âà†Èô§ -->

    <!-- ÂàÜÈ°µ -->
    <!-- ‰∏ÄÂÖ±Êúâ32Êù°Êï∞ÊçÆ
       pageNum=3,
       pageSize:2
    -->
    <div class="block">
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="pageNum"
        :page-sizes="[2, 4, 6, 8]"
        :page-size="pageSize"
        layout="total, sizes, prev, pager, next, jumper"
        :total="total"
        background
      ></el-pagination>
    </div>

    <!-- ÁºñËæëÁî®Êà∑ÂØπËØùÊ°Ü -->
    <el-dialog title="ÁºñËæëÁî®Êà∑" :visible.sync="dialogFormVisibleEdit">
      <el-form :model="form">
        <el-form-item label="Áî®Êà∑Âêç" :label-width="formLabelWidth">
          <el-input
            :disabled="true"
            prefix-icon="el-icon-user-solid"
            v-model="form.username"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="ÈÇÆÁÆ±" :label-width="formLabelWidth">
          <el-input clearable prefix-icon="el-icon-message" v-model="form.email" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="ÁîµËØù" :label-width="formLabelWidth">
          <el-input clearable prefix-icon="el-icon-phone" v-model="form.mobile" autocomplete="off"></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogFormVisibleEdit = false" type="warning">Âèñ Ê∂à</el-button>
        <el-button type="primary" @click="editUser()">Á°Æ ÂÆö</el-button>
      </div>
    </el-dialog>

    <!-- Ê∑ªÂä†Áî®Êà∑ÁöÑÂØπËØùÊ°Ü -->

    <el-dialog title="Ê∑ªÂä†Áî®Êà∑" :visible.sync="dialogFormVisibleAdd">
      <el-form :model="form">
        <el-form-item label="Áî®Êà∑Âêç" :label-width="formLabelWidth">
          <el-input prefix-icon="el-icon-user-solid" v-model="form.username" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="ÂØÜÁ†Å" :label-width="formLabelWidth">
          <el-input prefix-icon="el-icon-lock" v-model="form.password" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="ÈÇÆÁÆ±" :label-width="formLabelWidth">
          <el-input prefix-icon="el-icon-message" v-model="form.email" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="ÁîµËØù" :label-width="formLabelWidth">
          <el-input prefix-icon="el-icon-phone" v-model="form.mobile" autocomplete="off"></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogFormVisibleAdd = false" type="warning">Âèñ Ê∂à</el-button>
        <el-button type="primary" @click="addUser">Á°Æ ÂÆö</el-button>
      </div>
    </el-dialog>

    <!-- ÊùÉÈôêÂàÜÈÖç -->
    <el-drawer
      title="ÂàÜÈÖçÁî®Êà∑ËßíËâ≤"
      :before-close="handleClose"
      :visible.sync="dialog"
      direction="rtl"
      ref="drawer"
      :wrapperClosable="true"
    >
      <div style="padding:5%;height:auto">
        <el-form v-model="curr" :inline="true" label-position="left">
          <el-form-item label="Áî®Êà∑Âêç">{{curr.username}}</el-form-item>
          <el-form-item label="ËßíËâ≤">
            <el-select v-model="curr.rid" placeholder="ËØ∑ÈÄâÊã©Áî®Êà∑ËßíËâ≤" clearable>
              <el-option label="ËØ∑ÈÄâÊã©" :value="-1" :disabled="true"></el-option>
              <el-option
                v-for="(item, index) in roleList"
                :key="index"
                :label="item.roleName"
                :value="item.id"
              ></el-option>
            </el-select>
          </el-form-item>
        </el-form>
        <div>
          <el-button @click="cancel">Âèñ Ê∂à</el-button>
          <el-button
            type="primary"
            @click="$refs.drawer.closeDrawer()"
            :loading="loading"
          >{{ loading ? 'Êèê‰∫§‰∏≠ ...' : 'Á°Æ ÂÆö' }}</el-button>
        </div>
      </div>
    </el-drawer>
  </el-card>
</template>
<script>
export default {
  name: 'users',
  data () {
    return {
      level1: 'Áî®Êà∑ÁÆ°ÁêÜ',
      level2: 'Áî®Êà∑ÂàóË°®',
      query: '',
      pageNum: 1,
      pageSize: 6,
      total: -1,
      userList: [],
      fullscreenLoading: false,
      dialogFormVisibleAdd: false,
      dialogFormVisibleEdit: false,
      form: {
        username: '',
        password: '',
        email: '',
        mobile: ''
      },

      // ‰øùÂ≠òÊúâÁî®Êà∑ËßíËâ≤Êï∞ÊçÆ
      roleList: [],

      // ÂΩìÂâçÁî®Êà∑ÁöÑidÂíårid
      curr: {
        id: '',
        rid: ''
      },
      dialog: false,
      loading: false,
      formLabelWidth: '120px'
    }
  },
  methods: {
    // Á°ÆËÆ§ËßíËâ≤ÂàÜÈÖç‰øÆÊîπÂπ∂Êèê‰∫§ËØ∑Ê±Ç
    handleClose (done) {
      this.$confirm('Á°ÆÂÆöË¶ÅÊèê‰∫§Ë°®ÂçïÂêóÔºü')
        .then(async () => {
          this.loading = true
          const res = await this.$axios
            .put(`/users/${this.curr.id}`, {
              params: {
                rid: this.curr.rid
              }
            })
            .then(res => {
              const {
                meta: { msg, status }
              } = res.data
              if (status === 200) {
                this.$message({
                  message: msg,
                  type: 'success'
                })
              } else {
                this.$message({
                  message: msg,
                  type: 'error'
                })
              }
            })

          // ÊåâÈíÆÂä†ËΩΩ
          setTimeout(() => {
            this.loading = false
            done()
          }, 700)
        })
        .catch(() => {
          this.$message({
            message: 'Â∑≤ÂèñÊ∂à',
            type: 'warning'
          })
          this.dialog = false
        })
    },

    // ÂèñÊ∂àÂàÜÈÖçËßíËâ≤
    cancel () {
      this.dialog = false
      this.$message({
        message: 'Â∑≤ÂèñÊ∂à',
        type: 'warning'
      })
    },
    // ÂàÜÈÖçËßíËâ≤
    async showSetUserRoleDrawer (user) {
      const _this = this
      this.currUserName = user.username
      // Ëé∑ÂèñÁî®‰∫éËßíËâ≤ÂàóË°®
      const resRole = await this.$axios
        .get('/roles')
        .then(res => {
          const {
            data,
            meta: { msg, status }
          } = res.data
          if (status === 200) {
            _this.roleList = data
          }
        })
        .catch(err => {
          alert('ÊúçÂä°Âô®ÁÇ∏‰∫Ü(ÔΩûÔπÉÔΩû)~zZ')
        })

      // Ê†πÊçÆuseridÊü•ËØ¢Áî®Êà∑‰ø°ÊÅØËé∑ÂèñÁî®Êà∑ÂÖ®ÈÉ®‰ø°ÊÅØ
      const res = await this.$axios.get(`/users/${user.id}`).then(res => {
        const {
          meta: { msg, status },
          data: { id, rid, username }
        } = res.data
        if (status === 200) {
          this.curr = {
            id,
            rid,
            username
          }
          console.log(this.curr)
        } else {
          this.$message({
            message: msg,
            type: 'error'
          })
        }
      })
      this.dialog = true
    },
    // ËØ∑Ê±ÇÁî®Êà∑ÂàóË°®
    async getUserList () {
      // Êü•ËØ¢
      this.fullscreenLoading = true

      const res = await this.$axios
        .get(
          `/users?query=${this.query}&pagenum=${this.pageNum}&pagesize=${this.pageSize}`
        )
        .then(res => {
          const {
            meta: { msg, status },
            data: { users, total }
          } = res.data

          if (status === 200) {
            (this.userList = users),
            (this.total = total),
            setTimeout(() => {
              this.fullscreenLoading = false
            }, 700)
            setTimeout(() => {
              this.$message.success(msg)
            }, 700)
          }
        })
    },

    // ÊîπÂèòÁî®Êà∑Áä∂ÊÄÅ
    async changMsgState (user) {
      const res = await this.$axios
        .put(`/users/${user.id}/state/${user.mg_state}`)
        .then(res => {
          const {
            meta: { msg, status }
          } = res.data
          if (status === 200) {
            this.$message({
              message: msg,
              type: 'success'
            })
          } else {
            this.$message({
              message: msg,
              type: 'error'
            })
          }
        })
    },
    // Ê∑ªÂä†Áî®Êà∑
    async addUser () {
      this.dialogFormVisibleAdd = false
      const res = await this.$axios.post('/users', this.form).then(res => {
        const {
          meta: { msg, status },
          data
        } = res.data

        if (status === 201) {
          this.$message.success(msg)
          this.getUserList()

          // Ê∏ÖÁ©∫Ë°®Âçï
          for (const key in this.form) {
            if (this.form.hasOwnProperty(key)) {
              this.form[key] = ''
            }
          }
        } else {
          this.dialogFormVisibleAdd = true
          this.$notify.error({
            title: 'Ê∂àÊÅØ',
            message: msg,
            position: 'bottom-right'
          })
          this.form = {}
        }
      })
    },
    // ÁºñËæëÁî®Êà∑
    async editUser (user) {
      const res = await this.$axios
        .put(`/users/${this.form.id}`, this.form)
        .then(res => {
          const {
            meta: { msg, status }
          } = res.data
          if (status === 200) {
            this.dialogFormVisibleEdit = false
            this.$message.success(msg)
            this.getUserList()

            // Ê∏ÖÁ©∫Ë°®Âçï
            this.form = {}
          } else {
            this.$message.error(msg)
          }
        })
    },
    // Â±ïÁ§∫ÁºñËæëÁî®Êà∑ÂØπËØùÊ°Ü
    showEditUserDia (user) {
      this.form = user
      this.dialogFormVisibleEdit = true
    },
    // ÂºπÂá∫Âà†Èô§Ê®°ÊãüÊ°Ü
    showDeleUserMsgBox (userId) {
      this.$confirm('ÊòØÂê¶Ë¶ÅÂà†Èô§Áî®Êà∑?', 'ÊèêÁ§∫', {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      })
        .then(async () => {
          // ÂèëÈÄÅÂà†Èô§Áî®Êà∑ËØ∑Ê±Ç
          const res = await this.$axios.delete(`/users/${userId}`).then(res => {
            const {
              meta: { msg, status }
            } = res.data
            if (status === 200) {
              this.$message.success(msg)
              this.getUserList()
            } else {
              this.$message.error(msg)
            }
          })
        })
        .catch(() => {
          this.$message({
            type: 'info',
            message: 'Â∑≤ÂèñÊ∂àÂà†Èô§'
          })
        })
    },

    // ÂΩìÂâçÈ°µÈù¢Êï∞Êù°È°µÂèëÁîüÊîπÂèò
    handleSizeChange (val) {
      this.pageSize = val

      // ÂõûÂà∞Á¨¨‰∏ÄÈ°µ
      this.pageNum = 1
      this.getUserList()
    },

    // ÂΩìÂâçÈ°µÁ†ÅÊîπÂèò
    handleCurrentChange (val) {
      this.pageNum = val
      this.getUserList()
    },

    // ÊêúÁ¥†Áî®Êà∑
    searchUsers () {
      this.pageNum = 1
      this.pageSize = 6
      this.getUserList()
    }
  },
  created () {
    this.getUserList()
  }
}
</script>
<style lang="scss" scoped>
/deep/.box-card {
  height: 100%;
  .select {
    padding: 30px 0;
  }
  .block {
    padding: 30px 0;
  }
}
</style>
